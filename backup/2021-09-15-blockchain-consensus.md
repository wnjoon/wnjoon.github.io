---
layout: post
title:  "합의 알고리즘의 비교 (BFT vs CFT)" 
excerpt: "합의알고리즘은 크게 BFT(Byzantine Fault Tolerance)와 CFT(Crash Fault Tolerance)로 구분된다. 여기서 FT(Fault Tolerance)는 장애가 발생할 경우에도 시스템을 그대로 유지하여 서비스를 제공하기 위해 어디까지 충돌 또는 장애를 허용할지를 나타낸다. 일반적으로 CFT는 프라이빗 블록체인에, BFT는 퍼블릭 블록체인에서 사용된다."
date:   2021-09-15 15:00:00 +0900
categories: blockchain
tags: [합의알고리즘]
---

<br>

## 합의 알고리즘의 구분

블록체인을 지탱하고 있는 가장 큰 특징이라고 한다면 합의 알고리즘일 것이다. 거래 내역이 저장된 블록들이 하나의 체인으로 연결되어 있는데, 이렇게 만들어진 블록들의 체인이 여러 노드에 저장되어 위변조를 방지할 수 있게 된다. 물론 이를 위해서 모든 노드들이 거래 내역에 대한 상태(State)를 동일하게 유지해야 하는데, 이를 위해 합의 알고리즘이 필요하게 된다.  

합의알고리즘은 크게 BFT(Byzantine Fault Tolerance)와 CFT(Crash Fault Tolerance)로 구분된다. 여기서 <u>FT(Fault Tolerance)는 장애가 발생할 경우에도 시스템을 그대로 유지하여 서비스를 제공하기 위해 어디까지 충돌 또는 장애를 허용할지를 나타낸다.</u> 일반적으로 CFT는 프라이빗 블록체인에, BFT는 퍼블릭 블록체인에서 사용된다.

<br>

## BFT(Byzantine Fault Tolerance)

퍼블릭 블록체인에서 사용되는 합의 알고리즘은 블록체인에 참여하는 노드들이 매우 많고 각각의 상태가 다양하기 때문에, <u>정상적으로 동작하고 있지 않는 노드가 생각보다 많을 수 있다는 점을 고려</u>한다. 또한 퍼블릭 블록체인은 '보상' 이라는 인센티브 시스템이 존재하고 있다는 점도 검증된 신뢰환경을 바탕으로 하는 프라이빗 블록체인과 매우 다른 특징이 된다.
그러므로 퍼블릭 블록체인에서는 공공성과 보안성을 유지하는 것이 매우 중요한데, 대표적으로 3가지 합의알고리즘이 존재한다.

### 1. PoW(Proof of Work)

작업증명 알고리즘이라고 부르며, 블록을 생성하는 노드들 중 블록의 무결성을 보장하는 해시(Hash) 값을 가장 먼저 계산하는 노드에게 블록을 생성할 수 있는 자격을 주는 방식이다. 여기서 해시를 계산하는 과정을 전문용어로 '채굴'이라고 한다.  

채굴을 한다는 것은 곧 암호화폐, 보상을 얻는 행위이기 때문에 블록 생성 주기는 매우 중요한 요소가 된다. 그래서 채굴의 자격을 부여받는 해시 값은 특정 데이터의 규격을 만족해야만 하는데, 이 규격 안에서 적합한 해시값을 찾기 위해 수많은 컴퓨팅 자원과 에너지가 소모된다.  

결국 작업량이 많은 노드가 채굴을 통해 암호화폐를 얻을 확률이 매우 높아진다. 그리고 수많은 노드들 중 채굴에 성공한 단 하나의 노드만이 보상을 받기 때문에, 나머지 노드들은 헛수고한 셈이 될 수도 있다. 문제는 이렇게 헛수고하는 노드들이 많아질수록 채굴되는 암호화폐에 비해 자원과 에너지의 소모는 증가한다는 것이다. 대표적인 PoW 기반 블록체인인 비트코인의 경우 채굴을 전문적으로 하는 대형 채굴집단이 엄청나게 급증했는데, 2017년 기준 비트코인 채굴만으로 6,900만톤의 이산화탄소가 배출되었다고 하며 이는 전 세계 배출량의 1%에 해당하였다고 한다.  

대표적인 코인으로는 비트코인(BTC), 이더리움(ETH), 라이트코인(LTC), 모네로(XMR) 등이 있다.

### 2. PoS(Proof of Stake)

PoW의 단점인 자원과 에너지의 낭비 문제를 해결하기 위해 노드들 중 일부에게 블록을 생성할 수 있는 자격을 주는 방식이다. 자격은 노드가 보유하고 있는 코인의 지분량(Stake)와 해당 지분이 생성된 날짜로 결정된다. 지분이 많을수록 블록을 생성할 수 있는 권한이 높아진다.  

이 방법을 사용하면 채굴이라는 작업 없이도 코인의 획득이 가능하게 된다. 마치 이자를 받는 개념과 유사할 수 있는데, 지갑에 코인을 넣어두는 것 만으로도 보상의 기회가 주어지기 때문이다. 물론 고사양의 CPU나 그래픽카드를 요구하지도 않는다. 전기 사용량은 당연히 줄어든다.  

하지만 코인의 보유량에 따라 보상을 받기 때문에, 전형적인 '자본주의' 시스템이 된다. 특정 소수 자본가들은 계속해서 코인을 보상받을 것이고, 이는 코인 보유량에 따른 격차를 증가시킨다. 어찌보면 탈중앙화라는 말(물론 공산화의 느낌은 아니지만, 공평하다는 개념으로 접근할 경우)과 거리가 생기는 것 같기도 하다. 또 다른 문제로는 지갑에 코인이 많아야 또 다른 보상을 받는 구조이기 때문에, 코인의 유통량이 매우 떨어지게 된다. 결국 사용되지 않는 코인이 될 가능성이 높아질 수 있다.  

기술적으로는 Nothing of Stake 문제가 생길 수 있다. 이 문제는 높은 지분을 가지고 있다는 자격 요건을 활용해서 복수의 블록에게 투표하는 방식을 말한다. 이러한 악의적으로 블록의 생성에 관여하는 행위를 막기 위해 지분의 일부를 패널티(보증금) 형태로 삭감하는 방식도 고려되고 있다.  

대표적인 코인으로는 에이다(ADA), 알고랜드(ALGO), 테조스(XTZ), 셀로(CELO) 등이 있다.

### 3. DPoS(Delegated Proof of Stake)

위임지분증명 방식으로 최근에 나온 블록체인 시스템에서 가장 많이 채택하고 있는 합의 알고리즘이다. 네트워크를 구성하는 모든 노드들이 투표하여 블록을 생성할 수 있는 대표 노드를 선정하고, 이 대표 노드들 간 합의 과정을 거쳐서 블록을 생성한다. 합의 과정을 거치는 노드가 소수로 정해져 있기 때문에, 블록체인 시스템의 성능과 확장성이 매우 높아진다. EOS의 경우 21개의 대표 노드를 선정하는데, 약 20TPS를 갖는 이더리움에 비해 100배 이상인 3000TPS의 성능을 보인다.  

PoS와 다른 또 하나의 점은 지속적으로 지갑을 온라인에 연결해야 하는 PoS와 달리, 대표 노드로 선정된 노드에서 합의 과정을 통해 보상을 받고 이로부터 얻은 수익을 노드들에게 나누어주기 때문에 온라인에 대한 의존성이 매우 낮다. 하지만 이렇게 대표자 위주의 보상과 합의 과정은 탈중앙화와 거리가 너무 멀어진다는 우려가 많다. 또한 합의 알고리즘에 참여하는 숫자가 적어질 수록 보안이 취약해지는 것은 어쩔 수 없는 상황이다.  

대표적인 코인으로는 트론(TRX), 이오스(EOS), 루나(LUNA), 리스크(LSK) 등이 있다.

<br>

## CFT(Crash Fault Tolerance)

프라이빗 블록체인은 기존에 분산 컴퓨팅 환경에서 사용되던 FT 방식이 그대로 적용되기도 한다. 

### 1. Paxos

비잔틴 문제를 해결하기 위해 고안된 합의 알고리즘이다. 단 알고리즘이 매우 복잡하고 이해하기 어렵다는 단점 때문에 실제 시스템에 사용되는 것에 한계가 있다.

### 2. PBFT(Practical BFT)

비동기적으로 네트워크 상에서 합의를 이루는 방식이다. 리더로 선정된 한 노드가 받은 요청을 다른 노드들에게 전송하면, 해당 노드들은 다시 자신을 제외한 나머지 노드들에게 해당 요청을 전달한다. 만약 정족수 이상의 요청을 수신하고 이를 회신하게 되면, 해당 내용을 수행하고 결과에 따라 블록을 확정하는 방식이다.  

결국 다수결에 의한 합의 방식이기 때문에, 블록이 생성되는 과정에서 분기는 발생하지 않는다. 이를 Finality(완결성)가 보장된다고 말하는데, 즉 한번 확정된 블록은 절대 변경되지 않는다는 말이다.  

잘못된 노드가 존재하고 있더라도 나쁜 행위를 도모하기 위해서는 정족수(과반수) 이상의 노드를 확보해야 하는데, 이는 현실적으로 불가능하다. 혹은 리더로 선정된 노드가 잘못된 노드라고 해도, 리더는 모든 노드에게서 감시를 받는 구조이기 때문에 이 또한 현실적으로 불가능하다. 단, 의사결정을 위한 노드의 수가 제한적일 수 밖에 없다.

### 3. Raft([참고](https://wnjoon.github.io/2021/04/15/blockchain-raft/))

리더를 통해 메시지를 전파하고 이를 통해 합의를 도출하는 방식이다. 난수로 구성된 타임아웃값을 사용하여 리더를 선출하는데, 리더는 로그를 복제 및 관리하고, 다른 노드에게 메시지를 전달하여 정족수 이상의 응답자가 나올 경우에만 최종 합의로 반영하는 방식이다.  

Hyperledger Fabric에서는 Kafka-Zookeeper 방식을 deprecated하고 Raft 방식을 기본(default) 합의 알고리즘으로 지정하였다.

<br>

## 참고자료
- [가상화폐 기반인 블록체인 기술 연구 개발의 시스템 응용과 이슈 - 서울대학교 엄현상 교수](https://mysnu.org/m/community/newtechnology.php?search_order=&search_part=&c_cate1=&mode=v&idx=11700&thisPageNum=)
- [수학 문제 푸는 PoW, 지분 따라 돈 주는 PoS - 매일경제](https://www.mk.co.kr/news/economy/view/2021/07/671585/)
- [블록체인 면접 공부 - infiduk](https://infiduk.github.io/2019/10/26/blockchain-interview-questions.html#consensus-2-cft-vs-bft)